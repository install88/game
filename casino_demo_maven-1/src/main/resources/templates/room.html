<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head lang="en">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<title>StartUI - Premium Bootstrap 4 Admin Dashboard Template</title>

	<link href="assets/img/favicon.144x144.png" rel="apple-touch-icon" type="image/png" sizes="144x144">
	<link href="assets/img/favicon.114x114.png" rel="apple-touch-icon" type="image/png" sizes="114x114">
	<link href="assets/img/favicon.72x72.png" rel="apple-touch-icon" type="image/png" sizes="72x72">
	<link href="assets/img/favicon.57x57.png" rel="apple-touch-icon" type="image/png">
	<link href="assets/img/favicon.png" rel="icon" type="image/png">
	<link href="assets/img/favicon.ico" rel="shortcut icon">

	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
	<link rel="stylesheet" href="assets/css/separate/elements/player.min.css">
	<link rel="stylesheet" href="assets/css/lib/lobipanel/lobipanel.min.css">
	<link rel="stylesheet" href="assets/css/separate/vendor/lobipanel.min.css">
	<link rel="stylesheet" href="assets/css/lib/jqueryui/jquery-ui.min.css">
	<link rel="stylesheet" href="assets/css/separate/pages/widgets.min.css">
    <link rel="stylesheet" href="assets/css/lib/font-awesome/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/lib/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
</head>

<body class="with-side-menu dark-theme dark-theme-blue">
	<header th:replace="room_layout::header"></header><!--.site-header-->
	
	<div class="mobile-menu-left-overlay"></div>
	<nav th:replace="room_layout::left"></nav><!--.side-menu-->
	

	<div class="page-content">
	    <div class="container-fluid">
	        <div class="row">
	        	<div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-xs-12">
	        		<div class="cstm-video-player" style="background-image: url('assets/img/player-photo-b.jpg');">
						<div class="cstm-video-player-hover">
							<i class="font-icon font-icon-play"></i>
						</div>
						<div class="cstm-video-player-controls">
							<div class="cstm-video-player-progress">
								<div class="downloaded" style="width:75%"></div>
								<div class="played" style="width:35%"></div>
							</div>
							<div class="cstm-video-player-controls-left">
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-play"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-next"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-sound"></i>
								</button>
							</div>
							<div class="cstm-video-player-controls-right">
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-subtitres"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-settings"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-wide-screen"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-full-screen"></i>
								</button>
							</div>
						</div>
					</div>
	
				</div>
				<div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-xs-12">
					<div class="cstm-video-player" style="background-image: url('assets/img/player-photo-b.jpg');">
						<div class="cstm-video-player-hover">
							<i class="font-icon font-icon-play"></i>
						</div>
						<div class="cstm-video-player-controls">
							<div class="cstm-video-player-progress">
								<div class="downloaded" style="width:75%"></div>
								<div class="played" style="width:35%"></div>
							</div>
							<div class="cstm-video-player-controls-left">
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-play"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-next"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-sound"></i>
								</button>
							</div>
							<div class="cstm-video-player-controls-right">
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-subtitres"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-settings"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-wide-screen"></i>
								</button>
								<button type="button" class="cstm-video-player-btn">
									<i class="font-icon font-icon-player-full-screen"></i>
								</button>
							</div>
						</div>
					</div>
				</div>
	        </div><!--.row-->
	        <div class="row">
				<div class="col-xl-6">
					<div class="widget-chart-extra-section" >
						<div class="tbl widget-chart-extra-stat">
							<div class="tbl-row">
								<div class="tbl-cell">
									<div class="title">投注池總額：</div>
									<div class="number" id="amount">0</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-xl-6">
					<div id="labGameStatus"></div>
				</div>
			</div>
			<div class="space"></div>
			<div class="row">
				<div class="col-xl-12">
	                <div class="row">
	                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                        <article class="statistic-box red">
	                            <div>
	                                <div class="number" id="amount_a">0</div>
	                                <div class="caption"><div>A池</div></div>
	                                <div class="percent">
	                                    &nbsp;
	                                </div>
	                            </div>
	                        </article>
	                        
	                       <div style="text-align: center;">
	                        	<div class="btn-group btn-group-lg" role="group">
									<button type="button" class="btn btn-inline btn-primary" id="btnGroupA_100">+100</button>
									<button type="button" class="btn btn-inline btn-secondary" id="btnGroupA_200">+200</button>
									<button type="button" class="btn btn-inline btn-success" id="btnGroupA_500">+500</button>
								</div>
	                        </div>
	                        
	                    </div><!--.col-->
	                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                        <article class="statistic-box purple">
	                            <div>
	                                <div class="number" id="amount_b">0</div>
	                                <div class="caption"><div>B池</div></div>
	                                <div class="percent">
	                                    &nbsp;
	                                </div>
	                            </div>
	                        </article>
	                        <div style="text-align: center;">
	                        	<div class="btn-group btn-group-lg" role="group">
									<button type="button" class="btn btn-inline btn-primary" id="btnGroupB_100">+100</button>
									<button type="button" class="btn btn-inline btn-secondary" id="btnGroupB_200">+200</button>
									<button type="button" class="btn btn-inline btn-success" id="btnGroupB_500">+500</button>
								</div>
	                        </div>
	                    </div><!--.col-->
	                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                        <article class="statistic-box yellow">
	                            <div>
	                                <div class="number" id="amount_c">0</div>
	                                <div class="caption"><div>C池</div></div>
	                                <div class="percent">
	                                    &nbsp;
	                                </div>
	                            </div>
	                        </article>
	                        <div style="text-align: center;">
	                        	<div class="btn-group btn-group-lg" role="group" >
									<button type="button" class="btn btn-inline btn-primary" id="btnGroupC_100">+100</button>
									<button type="button" class="btn btn-inline btn-secondary" id="btnGroupC_200">+200</button>
									<button type="button" class="btn btn-inline btn-success" id="btnGroupC_500">+500</button>
								</div>
	                        </div>
	                    </div><!--.col-->
	                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 col-xs-12">
	                        <article class="statistic-box green">
	                            <div>
	                                <div class="number" id="amount_d">0</div>
	                                <div class="caption"><div>D池</div></div>
	                                <div class="percent">
	                                    &nbsp;
	                                </div>
	                            </div>
	                        </article>
	                        <div class="form-group" style="text-align: center;">
	                        	<div class="btn-group btn-group-lg" role="group" >
									<button type="button" class="btn btn-inline btn-primary" id="btnGroupD_100">+100</button>
									<button type="button" class="btn btn-inline btn-secondary" id="btnGroupD_200">+200</button>
									<button type="button" class="btn btn-inline btn-success" id="btnGroupD_500">+500</button>
								</div>
	                        </div>
	                    </div><!--.col-->
	                </div><!--.row-->
	            </div><!--.col-->
			</div>
	        <div class="row">
	            <div class="col-xl-6 dahsboard-column">
	               
	                
	            </div><!--.col-->
	            <div class="col-xl-6 dahsboard-column">
	                
	                
	            </div><!--.col-->
	        </div>
	    </div><!--.container-fluid-->
	</div><!--.page-content-->

	<script src="assets/js/lib/jquery/jquery-3.2.1.min.js"></script>
	<script src="assets/js/lib/popper/popper.min.js"></script>
	<script src="assets/js/lib/tether/tether.min.js"></script>
	<script src="assets/js/lib/bootstrap/bootstrap.min.js"></script>
	<script src="assets/js/plugins.js"></script>
	<script type="text/javascript" src="assets/js/lib/jqueryui/jquery-ui.min.js"></script>
	<script src="assets/js/sockjs.min.js"></script>
    <script src="assets/js/stomp.min.js"></script>
	

	<script>
		var roomNO = '[[${roomVO.no}]]';
	 	var stompClient = null;
	 	var socket = null;	 	
	 	var gameStatus = "";
		$(document).ready(function() {
			//WebSocket
	        connect();
			$("#btnGroupA_100").click(function(e){
				doBet(convertBet("A",100,roomNO));
				
			});
			$("#btnGroupA_200").click(function(e){
				doBet(convertBet("A",200,roomNO));
				
			});
			
			$("#btnGroupA_500").click(function(e){
				doBet(convertBet("A",500,roomNO));
			});
			
			$("#btnGroupB_100").click(function(e){
				doBet(convertBet("B",100,roomNO));
			});
			$("#btnGroupB_200").click(function(e){
				doBet(convertBet("B",200,roomNO));
			});
			$("#btnGroupB_500").click(function(e){
				doBet(convertBet("B",500,roomNO));
			});
			
			$("#btnGroupC_100").click(function(e){
				doBet(convertBet("C",100,roomNO));
			});
			$("#btnGroupC_200").click(function(e){
				doBet(convertBet("C",200,roomNO));
			});
			$("#btnGroupC_500").click(function(e){
				doBet(convertBet("C",500,roomNO));
			});
			
			$("#btnGroupD_100").click(function(e){
				doBet(convertBet("D",100,roomNO))
			});
			$("#btnGroupD_200").click(function(e){
				doBet(convertBet("D",200,roomNO))
			});
			$("#btnGroupD_500").click(function(e){
				doBet(convertBet("D",500,roomNO))
			});
			
		});
		function connect() {
			
	        socket = new SockJS("/ws?token=123456&roomNO="+roomNO);
	        stompClient = Stomp.over(socket);
	        stompClient.heartbeat.outgoing = 10000;
            stompClient.heartbeat.incoming = 0;
            var headers = {};
            
	        stompClient.connect(headers, function(frame) {
	            console.log('Connected:' + frame);
	         	/*
	            stompClient.subscribe('/user/topic/betBack',  function(data) {
	                console.log("data="+data);
	            	var jsonObj = $.parseJSON(data.body);
	            	var payload = jsonObj.payload;
            		var poolMap = payload.poolMap;
            		$("#amount").text(payload.amount);
	                $("#amount_a").text(poolMap["A"]);
	                $("#amount_b").text(poolMap["B"]);
	                $("#amount_c").text(poolMap["C"]);
	                $("#amount_d").text(poolMap["D"]);
	                
	            });
	            */
	            stompClient.subscribe('/user/topic/roomStatus',  function(data) {
	                console.log("data="+data);
	            	var jsonObj = $.parseJSON(data.body);
	            	var payload = jsonObj.payload;
            		var poolMap = payload.poolMap;
            		$("#amount").text(payload.amount);
	                $("#amount_a").text(poolMap["A"]);
	                $("#amount_b").text(poolMap["B"]);
	                $("#amount_c").text(poolMap["C"]);
	                $("#amount_d").text(poolMap["D"]);
	                if("INIT" == payload.gameStatus){
	                	$("#labGameStatus").html("<h2> <font color='red'>遊戲要開始囉！</font></h2>");
	                	getMyWalletAmount();
	                	gameStatus = "INIT";
	                }
	                if("BETTING" == payload.gameStatus){
	                	$("#labGameStatus").html("<h2> <font color='red'>開始下注</font></h2>");
	                	getMyWalletAmount();
	                	gameStatus = "BETTING";
	                }
	                if("RUNNING" == payload.gameStatus ){
	                	$("#labGameStatus").html("<h2> <font color='red'>遊戲開始了</font></h2>");
	                	getMyWalletAmount();
	                	gameStatus = "RUNNING";
	                }
	                if("DRAWING" == payload.gameStatus ){
	                	$("#labGameStatus").html("<h2> <font color='red'>派彩</font></h2>");
	                	getMyWalletAmount();
	                	gameStatus = "DRAWING";
	                }
	                if("CLOSE" == payload.gameStatus ){
	                	$("#labGameStatus").html("<h2> <font color='red'>遊戲結束了</font></h2>");
	                	getMyWalletAmount();
	                	gameStatus = "CLOSE";
	                }
	                console.log("commplete read status!");
	            });
	       
	            stompClient.subscribe('/user/topic/getMyWallet',  function(data) {
	                console.log("data="+data);
	                var jsonObj = $.parseJSON(data.body);
	                var payload = jsonObj.payload;
	                $("#myWallet").text(payload["amount"]);
	                console.log("commplete read my wallet!");
	            });
	            getRoomStatus();
	       }, function (error) {
               console.log('STOMP: ' + error);
               console.log('STOMP: Reconnecting in 10 seconds');
           });
	        
		}
	            
	      
	    function disconnect() {
	        if (stompClient != null) {
	            stompClient.disconnect();
	        }
	        console.log("Disconnected");
	    }
	    function doBet(msg) {
	    	var bet_msg = JSON.parse(msg);
	    	if("BETTING" == gameStatus){
	    		var total_amount = parseInt($("#amount").text());
	    		var bet_amount = bet_msg.amount;	    		
				var myWallet = parseInt($("#myWallet").text());
	    		if(myWallet < bet_amount){
	    			alert("餘額不足！");
	    			return
	    		}
	    			    		
	    		if(total_amount + bet_amount <= 3000){
	    			stompClient.send("/app/casino/bet", {}, msg);	
	    		}else{
	    			alert("目前已超過下注上限！");
	    		}	    		
	    	}else{
	    		alert("當開放下注時，才可以壓喔！");
	    	}
	        
	    }
	    function getRoomStatus(){
	    	stompClient.send("/app/casino/getStatus", {}, JSON.stringify({'roomNO': roomNO}));
	    }
	    function getMyWalletAmount(){
	    	stompClient.send("/app/casino/getMyWalletAmount", {},"");
	    }
	    function convertBet(target, amount, roomNO){
	        var c = {target:target, amount:amount, roomNO:roomNO};
	        return  JSON.stringify(c);
	    }

	</script>

<script src="assets/js/app.js"></script>
</body>
</html>